// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.19;

import {Test, console2} from "forge-std/Test.sol";
import {PortalV2MultiAsset} from "src/V2MultiAsset/PortalV2MultiAsset.sol";
import {MintBurnToken} from "src/V2MultiAsset/MintBurnToken.sol";
import {VirtualLP} from "src/V2MultiAsset/VirtualLP.sol";
import {ErrorsLib} from "./libraries/ErrorsLib.sol";
import {EventsLib} from "./libraries/EventsLib.sol";
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {IWater} from "src/V2MultiAsset/interfaces/IWater.sol";
import {ISingleStaking} from "src/V2MultiAsset/interfaces/ISingleStaking.sol";
import {IDualStaking} from "src/V2MultiAsset/interfaces/IDualStaking.sol";
import {IPortalV2MultiAsset} from "src/V2MultiAsset/interfaces/IPortalV2MultiAsset.sol";

import {SymTest} from "halmos-cheatcodes/SymTest.sol";
import "./Interfaces/interfaces.sol";
import {console2} from "forge-std/console2.sol";



contract Halmos_ZealynxTest is SymTest, Test {
// External token addresses
    // address constant WETH_ADDRESS = 0x82aF49447D8a07e3bd95BD0d56f35241523fBab1;
    Weth_address WETH_ADDRESS;

    // address public constant PSM_ADDRESS = 0x17A8541B82BF67e10B0874284b4Ae66858cb1fd5;
    Psm_address PSM_ADDRESS;

    // address constant esVKA = 0x95b3F9797077DDCa971aB8524b439553a220EB2A;
    esvka esVKA;
    // Vaultka staking contracts
    // address constant SINGLE_STAKING = 0x314223E2fA375F972E159002Eb72A96301E99e22;
    single_staking SINGLE_STAKING;

    // address constant DUAL_STAKING = 0x31Fa38A6381e9d1f4770C73AB14a0ced1528A65E;
    dual_staking DUAL_STAKING;

    uint256 constant _POOL_ID_USDC = 5;
    uint256 constant _POOL_ID_WETH = 10;

    // address private constant USDC_WATER = 0x9045ae36f963b7184861BDce205ea8B08913B48c;
    usdc_water USDC_WATER;

    // address private constant WETH_WATER = 0x8A98929750e6709Af765F976c6bddb5BfFE6C06c;
    weth_water WETH_WATER;
    // address private constant _PRINCIPAL_TOKEN_ADDRESS_USDC = 0xaf88d065e77c8cC2239327C5EDb3A432268e5831;
    principal_token_address_usdc _PRINCIPAL_TOKEN_ADDRESS_USDC;

    // address private constant _PRINCIPAL_TOKEN_ADDRESS_ETH = address(0);
    address _PRINCIPAL_TOKEN_ADDRESS_ETH;

    // General constants
    uint256 constant _TERMINAL_MAX_LOCK_DURATION = 157680000;
    uint256 private constant SECONDS_PER_YEAR = 31536000; // seconds in a 365 day year
    uint256 public maxLockDuration = 7776000; // 7776000 starting value for maximum allowed lock duration of userÂ´s balance in seconds (90 days)
    uint256 private constant OWNER_DURATION = 31536000; // 1 Year

    // Portal Constructor values
    uint256 constant _TARGET_CONSTANT_USDC = 440528634361 * 1e36;
    uint256 constant _TARGET_CONSTANT_WETH = 125714213 * 1e36;

    uint256 constant _FUNDING_PHASE_DURATION = 604800; // 7 days
    uint256 constant _FUNDING_MIN_AMOUNT = 1e25; // 10M PSM

    uint256 constant _DECIMALS = 18;
    uint256 constant _DECIMALS_USDC = 6;

    uint256 constant _AMOUNT_TO_CONVERT = 100000 * 1e18;

    string _META_DATA_URI = "abcd";

    // time
    uint256 timestamp;
    uint256 fundingPhase;
    uint256 ownerExpiry;
    uint256 hundredYearsLater;

    // prank addresses
    // address payable Alice = payable(0x46340b20830761efd32832A74d7169B29FEB9758);
    // address payable Bob = payable(0xDD56CFdDB0002f4d7f8CC0563FD489971899cb79);
    // address payable Karen = payable(0x3A30aaf1189E830b02416fb8C513373C659ed748);


    address public Alice;
    address public Bob;
    address public Karen;

    // Token Instances
    // IERC20 psm = IERC20(PSM_ADDRESS);
    // IERC20 usdc = IERC20(_PRINCIPAL_TOKEN_ADDRESS_USDC);
    // IERC20 weth = IERC20(WETH_ADDRESS);
    IERC20 public psm;
    IERC20 public weth;
    IERC20 public usdc;

    // Portals & LP
    PortalV2MultiAsset public portal_USDC;
    PortalV2MultiAsset public portal_ETH;
    VirtualLP public virtualLP;

    // Simulated USDC distributor
    // address usdcSender = 0xF977814e90dA44bFA03b6295A0616a897441aceC;
    address public usdcSender;


    // PSM Treasury
    // address psmSender = 0xAb845D09933f52af5642FC87Dd8FBbf553fd7B33;
    address public psmSender;

    // starting token amounts
    uint256 usdcAmount = 1e12; // 1M USDC
    uint256 psmAmount = 1e25; // 10M PSM
    uint256 usdcSendAmount = 1e9; // 1k USDC


    ////////////// SETUP ////////////////////////
    function setUp() public {
        Alice = svm.createAddress("Alice");
        Bob = svm.createAddress("Bob");
        Karen = svm.createAddress("Karen");
        usdcSender = svm.createAddress("usdcSender");
        psmSender = svm.createAddress("psmSender");
        

        //Address contracts
        WETH_ADDRESS = Weth_address(address(new EmptyContract()));
        vm.etch(address(WETH_ADDRESS), hex"60806040526004361061004e5760003560e01c80633659cfe6146100655780634f1ef286146100985780635c60da1b146101185780638f28397014610149578063f851a4401461017c5761005d565b3661005d5761005b610191565b005b61005b610191565b34801561007157600080fd5b5061005b6004803603602081101561008857600080fd5b50356001600160a01b03166101ab565b61005b600480360360408110156100ae57600080fd5b6001600160a01b0382351691908101906040810160208201356401000000008111156100d957600080fd5b8201836020820111156100eb57600080fd5b8035906020019184600183028401116401000000008311171561010d57600080fd5b5090925090506101e5565b34801561012457600080fd5b5061012d610262565b604080516001600160a01b039092168252519081900360200190f35b34801561015557600080fd5b5061005b6004803603602081101561016c57600080fd5b50356001600160a01b031661029f565b34801561018857600080fd5b5061012d610359565b6101996103b6565b6101a96101a4610416565b61043b565b565b6101b361045f565b6001600160a01b0316336001600160a01b031614156101da576101d581610484565b6101e2565b6101e2610191565b50565b6101ed61045f565b6001600160a01b0316336001600160a01b031614156102555761020f83610484565b61024f8383838080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061038492505050565b5061025d565b61025d610191565b505050565b600061026c61045f565b6001600160a01b0316336001600160a01b031614156102945761028d610416565b905061029c565b61029c610191565b90565b6102a761045f565b6001600160a01b0316336001600160a01b031614156101da576001600160a01b0381166103055760405162461bcd60e51b815260040180806020018281038252603a8152602001806106f8603a913960400191505060405180910390fd5b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f61032e61045f565b604080516001600160a01b03928316815291841660208301528051918290030190a16101d5816104c4565b600061036361045f565b6001600160a01b0316336001600160a01b031614156102945761028d61045f565b60606103a98383604051806060016040528060278152602001610732602791396104e8565b9392505050565b3b151590565b6103be61045f565b6001600160a01b0316336001600160a01b0316141561040e5760405162461bcd60e51b81526004018080602001828103825260428152602001806107b56042913960600191505060405180910390fd5b6101a96101a9565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5490565b3660008037600080366000845af43d6000803e80801561045a573d6000f35b3d6000fd5b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035490565b61048d816105eb565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b7fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d610355565b60606104f3846103b0565b61052e5760405162461bcd60e51b815260040180806020018281038252602681526020018061078f6026913960400191505060405180910390fd5b60006060856001600160a01b0316856040518082805190602001908083835b6020831061056c5780518252601f19909201916020918201910161054d565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d80600081146105cc576040519150601f19603f3d011682016040523d82523d6000602084013e6105d1565b606091505b50915091506105e1828286610653565b9695505050505050565b6105f4816103b0565b61062f5760405162461bcd60e51b81526004018080602001828103825260368152602001806107596036913960400191505060405180910390fd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc55565b606083156106625750816103a9565b8251156106725782518084602001fd5b8160405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156106bc5781810151838201526020016106a4565b50505050905090810190601f1680156106e95780820380516001836020036101000a031916815260200191505b509250505060405180910390fdfe5472616e73706172656e745570677261646561626c6550726f78793a206e65772061646d696e20697320746865207a65726f2061646472657373416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c65645570677261646561626c6550726f78793a206e657720696d706c656d656e746174696f6e206973206e6f74206120636f6e7472616374416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f6e74726163745472616e73706172656e745570677261646561626c6550726f78793a2061646d696e2063616e6e6f742066616c6c6261636b20746f2070726f787920746172676574a26469706673582212206c7d9f9210050a2a3b139e9018b711bee78264b2de59dd83f2d515ee541efbf564736f6c634300060c0033");
        // WETH_ADDRESS = Weth_address(WETH_ADDRESS);
        weth = IERC20(address(WETH_ADDRESS));

        PSM_ADDRESS = Psm_address(address(new EmptyContract2()));
        vm.etch(address(PSM_ADDRESS), hex"60806040523661001357610011610017565b005b6100115b61001f61002f565b61002f61002a61013c565b6101af565b565b3b151590565b606061004284610031565b61007d5760405162461bcd60e51b815260040180806020018281038252602681526020018061029d6026913960400191505060405180910390fd5b60006060856001600160a01b0316856040518082805190602001908083835b602083106100bb5780518252601f19909201916020918201910161009c565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d806000811461011b576040519150601f19603f3d011682016040523d82523d6000602084013e610120565b606091505b50915091506101308282866101d3565b925050505b9392505050565b6000610146610277565b6001600160a01b0316635c60da1b6040518163ffffffff1660e01b815260040160206040518083038186803b15801561017e57600080fd5b505afa158015610192573d6000803e3d6000fd5b505050506040513d60208110156101a857600080fd5b5051905090565b3660008037600080366000845af43d6000803e8080156101ce573d6000f35b3d6000fd5b606083156101e2575081610135565b8251156101f25782518084602001fd5b8160405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b8381101561023c578181015183820152602001610224565b50505050905090810190601f1680156102695780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b7fa3f0ad74e5423aebfd80d3ef4346578335a9a72aeaee59ff6cb3582b35133d50549056fe416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f6e7472616374a2646970667358221220aeef0abef4c11b04ff0868cdc7dcb509103be03cfebb8f3070abd786c02b421064736f6c634300060b0033");
        // PSM_ADDRESS = Psm_address(token2);
        psm = IERC20(address(PSM_ADDRESS));


        esVKA = esvka(address(new EmptyContract3()));
        vm.etch(address(esVKA), hex"608060405234801561001057600080fd5b50600436106101425760003560e01c8063715018a6116100b85780639cb7de4b1161007c5780639cb7de4b146102fa578063a9059cbb1461030d578063b0adb83c14610320578063dd62ed3e14610333578063dfbaefb11461036c578063f2fde38b1461037957600080fd5b8063715018a61461028b57806373e3860b146102935780638400c307146102be5780638da5cb5b146102e157806395d89b41146102f257600080fd5b8063313ce5671161010a578063313ce567146101d257806342966c68146101ec57806346ea87af1461020157806355b6ed5c146102245780635a47a1a71461024f57806370a082311461026257600080fd5b806306fdde0314610147578063095ea7b31461016557806318160ddd1461018857806323b872dd1461019f57806327e235e3146101b2575b600080fd5b61014f61038c565b60405161015c9190610a05565b60405180910390f35b610178610173366004610a6f565b61041a565b604051901515815260200161015c565b61019160045481565b60405190815260200161015c565b6101786101ad366004610a99565b610431565b6101916101c0366004610ad5565b60056020526000908152604090205481565b6101da601281565b60405160ff909116815260200161015c565b6101ff6101fa366004610af7565b6104eb565b005b61017861020f366004610ad5565b60086020526000908152604090205460ff1681565b610191610232366004610b10565b600660209081526000928352604080842090915290825290205481565b6101ff61025d366004610b53565b610547565b610191610270366004610ad5565b6001600160a01b031660009081526005602052604090205490565b6101ff610562565b6001546102a6906001600160a01b031681565b6040516001600160a01b03909116815260200161015c565b6101786102cc366004610ad5565b60076020526000908152604090205460ff1681565b6000546001600160a01b03166102a6565b61014f610576565b6101ff610308366004610b6e565b610583565b61017861031b366004610a6f565b6105b6565b6101ff61032e366004610b6e565b6105c3565b610191610341366004610b10565b6001600160a01b03918216600090815260066020908152604080832093909416825291909152205490565b6009546101789060ff1681565b6101ff610387366004610ad5565b6105f6565b6002805461039990610b98565b80601f01602080910402602001604051908101604052809291908181526020018280546103c590610b98565b80156104125780601f106103e757610100808354040283529160200191610412565b820191906000526020600020905b8154815290600101906020018083116103f557829003601f168201915b505050505081565b600061042733848461066c565b5060015b92915050565b6001600160a01b0383166000908152600660209081526040808320338452909152812054828110156104bb5760405162461bcd60e51b815260206004820152602860248201527f6573564b413a207472616e7366657220616d6f756e74206578636565647320616044820152676c6c6f77616e636560c01b60648201526084015b60405180910390fd5b60006104c78483610be8565b90506104d486338361066c565b6104df86868661072f565b50600195945050505050565b3360009081526008602052604090205460ff1661053a5760405162461bcd60e51b815260206004820152600d60248201526c3737ba1030903430b7323632b960991b60448201526064016104b2565b61054433826108d0565b50565b61054f61095b565b6009805460ff1916911515919091179055565b61056a61095b565b61057460006109b5565b565b6003805461039990610b98565b61058b61095b565b6001600160a01b03919091166000908152600860205260409020805460ff1916911515919091179055565b600061042733848461072f565b6105cb61095b565b6001600160a01b03919091166000908152600760205260409020805460ff1916911515919091179055565b6105fe61095b565b6001600160a01b0381166106635760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084016104b2565b610544816109b5565b6001600160a01b0382166106cd5760405162461bcd60e51b815260206004820152602260248201527f6573564b413a20617070726f766520746f20746865207a65726f206164647265604482015261737360f01b60648201526084016104b2565b6001600160a01b0383811660008181526006602090815260408083209487168084529482529182902085905590518481527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92591015b60405180910390a3505050565b6001600160a01b0382166107915760405162461bcd60e51b815260206004820152602360248201527f6573564b413a207472616e7366657220746f20746865207a65726f206164647260448201526265737360e81b60648201526084016104b2565b6001600160a01b03821660009081526007602052604090205460ff16806107d057506001600160a01b03831660009081526007602052604090205460ff165b61082f5760405162461bcd60e51b815260206004820152602a60248201527f6573564b413a20726563697069656e74206f722073656e646572206e6f7420776044820152691a1a5d195b1a5cdd195960b21b60648201526084016104b2565b6001600160a01b03831660009081526005602052604081208054839290610857908490610be8565b90915550506001600160a01b03821660009081526005602052604081208054839290610884908490610bfb565b92505081905550816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161072291815260200190565b6001600160a01b038216600090815260056020526040812080548392906108f8908490610be8565b9250508190555080600460008282546109119190610be8565b90915550506040518181526000906001600160a01b038416907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9060200160405180910390a35050565b6000546001600160a01b031633146105745760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657260448201526064016104b2565b600080546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b600060208083528351808285015260005b81811015610a3257858101830151858201604001528201610a16565b506000604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b0381168114610a6a57600080fd5b919050565b60008060408385031215610a8257600080fd5b610a8b83610a53565b946020939093013593505050565b600080600060608486031215610aae57600080fd5b610ab784610a53565b9250610ac560208501610a53565b9150604084013590509250925092565b600060208284031215610ae757600080fd5b610af082610a53565b9392505050565b600060208284031215610b0957600080fd5b5035919050565b60008060408385031215610b2357600080fd5b610b2c83610a53565b9150610b3a60208401610a53565b90509250929050565b80358015158114610a6a57600080fd5b600060208284031215610b6557600080fd5b610af082610b43565b60008060408385031215610b8157600080fd5b610b8a83610a53565b9150610b3a60208401610b43565b600181811c90821680610bac57607f821691505b602082108103610bcc57634e487b7160e01b600052602260045260246000fd5b50919050565b634e487b7160e01b600052601160045260246000fd5b8181038181111561042b5761042b610bd2565b8082018082111561042b5761042b610bd256fea26469706673582212200908bdc3870adc2aef2c515755f1594e2d6e35cdb719d142373e08d53ea69a2764736f6c63430008120033");
        // esVKA = esvka(token3);

        SINGLE_STAKING = single_staking(address(new EmptyContract4()));
        vm.etch(address(SINGLE_STAKING), hex"60806040523661001357610011610017565b005b6100115b61001f6101b7565b6001600160a01b0316336001600160a01b0316141561016f5760606001600160e01b031960003516631b2ce7f360e11b8114156100655761005e6101ea565b9150610167565b6001600160e01b0319811663278f794360e11b14156100865761005e610241565b6001600160e01b031981166308f2839760e41b14156100a75761005e610287565b6001600160e01b031981166303e1469160e61b14156100c85761005e6102b8565b6001600160e01b03198116635c60da1b60e01b14156100e95761005e6102f8565b60405162461bcd60e51b815260206004820152604260248201527f5472616e73706172656e745570677261646561626c6550726f78793a2061646d60448201527f696e2063616e6e6f742066616c6c6261636b20746f2070726f78792074617267606482015261195d60f21b608482015260a4015b60405180910390fd5b815160208301f35b61017761030c565b565b606061019e83836040518060600160405280602781526020016108576027913961031c565b9392505050565b90565b6001600160a01b03163b151590565b60007fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035b546001600160a01b0316919050565b60606101f4610394565b600061020336600481846106a2565b81019061021091906106e8565b905061022d8160405180602001604052806000815250600061039f565b505060408051602081019091526000815290565b606060008061025336600481846106a2565b8101906102609190610719565b915091506102708282600161039f565b604051806020016040528060008152509250505090565b6060610291610394565b60006102a036600481846106a2565b8101906102ad91906106e8565b905061022d816103cb565b60606102c2610394565b60006102cc6101b7565b604080516001600160a01b03831660208201529192500160405160208183030381529060405291505090565b6060610302610394565b60006102cc610422565b610177610317610422565b610431565b6060600080856001600160a01b0316856040516103399190610807565b600060405180830381855af49150503d8060008114610374576040519150601f19603f3d011682016040523d82523d6000602084013e610379565b606091505b509150915061038a86838387610455565b9695505050505050565b341561017757600080fd5b6103a8836104d3565b6000825111806103b55750805b156103c6576103c48383610179565b505b505050565b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f6103f46101b7565b604080516001600160a01b03928316815291841660208301520160405180910390a161041f81610513565b50565b600061042c6105bc565b905090565b3660008037600080366000845af43d6000803e808015610450573d6000f35b3d6000fd5b606083156104c15782516104ba576001600160a01b0385163b6104ba5760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161015e565b50816104cb565b6104cb83836105e4565b949350505050565b6104dc8161060e565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6001600160a01b0381166105785760405162461bcd60e51b815260206004820152602660248201527f455243313936373a206e65772061646d696e20697320746865207a65726f206160448201526564647265737360d01b606482015260840161015e565b807fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035b80546001600160a01b0319166001600160a01b039290921691909117905550565b60007f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc6101db565b8151156105f45781518083602001fd5b8060405162461bcd60e51b815260040161015e9190610823565b6001600160a01b0381163b61067b5760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b606482015260840161015e565b807f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc61059b565b600080858511156106b257600080fd5b838611156106bf57600080fd5b5050820193919092039150565b80356001600160a01b03811681146106e357600080fd5b919050565b6000602082840312156106fa57600080fd5b61019e826106cc565b634e487b7160e01b600052604160045260246000fd5b6000806040838503121561072c57600080fd5b610735836106cc565b9150602083013567ffffffffffffffff8082111561075257600080fd5b818501915085601f83011261076657600080fd5b81358181111561077857610778610703565b604051601f8201601f19908116603f011681019083821181831017156107a0576107a0610703565b816040528281528860208487010111156107b957600080fd5b8260208601602083013760006020848301015280955050505050509250929050565b60005b838110156107f65781810151838201526020016107de565b838111156103c45750506000910152565b600082516108198184602087016107db565b9190910192915050565b60208152600082518060208401526108428160408501602087016107db565b601f01601f1916919091016040019291505056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a264697066735822122012bb4f564f73959a03513dc74fc3c6e40e8386e6f02c16b78d6db00ce0aa16af64736f6c63430008090033");
        // SINGLE_STAKING = single_staking(token4);

        DUAL_STAKING = dual_staking(address(new EmptyContract5()));
        vm.etch(address(DUAL_STAKING), hex"608060405234801561001057600080fd5b506004361061025c5760003560e01c80637acb775711610146578063cc1a378f116100c3578063f23ad8d611610087578063f23ad8d61461056c578063f2fde38b14610575578063f5d9d63e14610588578063f69e2046146105b3578063f7c31c15146105bb578063f7c618c1146105c457600080fd5b8063cc1a378f14610503578063cd3daf9d14610516578063df136d651461051e578063e27b2c5d14610527578063ebe2b12b1461056357600080fd5b8063aaf4a9661161010a578063aaf4a966146104ac578063bbbd12d3146104b4578063c57a202c146104c7578063c8f33c91146104e7578063ca020d39146104f057600080fd5b80637acb7757146104525780637b0a47ee1461046557806380faa57d1461046e5780638b876347146104765780638da5cb5b1461049657600080fd5b8063386a9525116101df578063516f0a1b116101a3578063516f0a1b146103f7578063567e98f91461041a5780635c975abb146104235780636d2fd89a1461042e578063715018a6146104375780637a5c86da1461043f57600080fd5b8063386a95251461038d5780633c6b16ab146103965780633d18b912146103a957806343df9e73146103b157806346ea87af146103c457600080fd5b806311dff2591161022657806311dff2591461031b57806311eac8551461034257806316d18e01146103695780631c1f78eb1461037c578063304f99551461038457600080fd5b80628cc26214610261578062f714ce146102875780630700037d1461029c5780630ab8985b146102bc57806310c1c103146102fb575b600080fd5b61027461026f366004611c3e565b6105eb565b6040519081526020015b60405180910390f35b61029a610295366004611c59565b610684565b005b6102746102aa366004611c3e565b600e6020526000908152604090205481565b6102e37f000000000000000000000000afccb724e3aec1657fc9514e3e53a0e71e80622d81565b6040516001600160a01b03909116815260200161027e565b610274610309366004611c3e565b60106020526000908152604090205481565b6102e37f00000000000000000000000095b3f9797077ddca971ab8524b439553a220eb2a81565b6102e37f000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc881565b61029a610377366004611c85565b610944565b610274610a91565b610274600a5481565b61027460045481565b61029a6103a4366004611c85565b610aa8565b61029a610d0b565b61029a6103bf366004611cac565b610e26565b6103e76103d2366004611c3e565b60126020526000908152604090205460ff1681565b604051901515815260200161027e565b6103e7610405366004611c3e565b60116020526000908152604090205460ff1681565b61027460085481565b60015460ff166103e7565b61027460095481565b61029a610e9e565b61029a61044d366004611c85565b610eb0565b61029a610460366004611c59565b610f32565b61027460035481565b6102746111a2565b610274610484366004611c3e565b600d6020526000908152604090205481565b60015461010090046001600160a01b03166102e3565b61029a6111b9565b6102746104c2366004611c3e565b6112a4565b6102746104d5366004611c3e565b600c6020526000908152604090205481565b61027460055481565b6102746104fe366004611c3e565b611325565b61029a610511366004611c85565b61138d565b610274611468565b61027460075481565b61054e610535366004611c3e565b6013602052600090815260409020805460019091015482565b6040805192835260208301919091520161027e565b61027460025481565b61027460065481565b61029a610583366004611c3e565b6114da565b610274610596366004611ce3565b600f60209081526000928352604080842090915290825290205481565b61029a611550565b610274600b5481565b6102e37f00000000000000000000000095b3f9797077ddca971ab8524b439553a220eb2a81565b6001600160a01b0381166000908152600d6020526040812054819061060e611468565b6106189190611d23565b6001600160a01b03841660009081526010602052604081205491925090670de0b6b3a76400009061064a908490611d3c565b6106549190611d53565b6001600160a01b0385166000908152600e60205260408120549192509061067b9083611d75565b95945050505050565b61068c611716565b33610695611468565b6007556106a06111a2565b6005556001600160a01b038116156106e7576106bb816105eb565b6001600160a01b0382166000908152600e6020908152604080832093909355600754600d909152919020555b600083116107305760405162461bcd60e51b8152602060048201526011602482015270043616e6e6f74207769746864726177203607c1b60448201526064015b60405180910390fd5b336000908152600f602090815260408083206001600160a01b03861684529091529020548311156107b65760405162461bcd60e51b815260206004820152602a60248201527f5769746864726177616c20616d6f756e742065786365656473206465706f73696044820152691d195908185b5bdd5b9d60b21b6064820152608401610727565b600b54336000908152600c60205260409020546107d39190611d75565b42101561082d5760405162461bcd60e51b815260206004820152602260248201527f5769746864726177616c2074696d656c6f636b206e6f74207965742070617373604482015261195960f21b6064820152608401610727565b61083561176f565b3360009081526013602052604081206008805491928692610857908490611d23565b9091555050336000908152601060205260408120805486929061087b908490611d23565b9091555050336000908152600f602090815260408083206001600160a01b0387168452909152812080548692906108b3908490611d23565b909155505060095433600090815260106020526040902054670de0b6b3a7640000916108de91611d3c565b6108e89190611d53565b81556108fe6001600160a01b0384163386611817565b60405184815233907f7084f5476618d8e60b11ef0d7d3f06914655adb8793e28ff7f018d4c76d505d5906020015b60405180910390a250506109406001600055565b5050565b3360009081526011602052604090205460ff166109935760405162461bcd60e51b815260206004820152600d60248201526c4f4e4c595f545245415355525960981b6044820152606401610727565b600081116109de5760405162461bcd60e51b8152602060048201526018602482015277050726f746f636f6c20466565206c657373207468616e20360441b6044820152606401610727565b600060085411610a235760405162461bcd60e51b815260206004820152601060248201526f139bc81cdd185ad95908185b5bdd5b9d60821b6044820152606401610727565b600854610a3882670de0b6b3a7640000611d3c565b610a429190611d53565b60096000828254610a539190611d75565b90915550610a8e90506001600160a01b037f000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc81633308461187f565b50565b6000600454600354610aa39190611d3c565b905090565b6000610ab2611468565b600755610abd6111a2565b6005556001600160a01b03811615610b0457610ad8816105eb565b6001600160a01b0382166000908152600e6020908152604080832093909355600754600d909152919020555b3360009081526012602052604090205460ff16610b725760405162461bcd60e51b815260206004820152602660248201527f4475616c5374616b696e673a2063616c6c6572206973206e6f7420746865206860448201526530b7323632b960d11b6064820152608401610727565b60008211610bb75760405162461bcd60e51b815260206004820152601260248201527105265776172642063616e6e6f7420626520360741b6044820152606401610727565b6002544210610bd557600454610bcd9083611d53565b600355610c17565b600042600254610be59190611d23565b9050600060035482610bf79190611d3c565b600454909150610c078286611d75565b610c119190611d53565b60035550505b8160066000828254610c299190611d75565b9091555050600454600654610c3e9190611d53565b6003541115610c8a5760405162461bcd60e51b81526020600482015260186024820152770a0e4deecd2c8cac840e4caeec2e4c840e8dede40d0d2ced60431b6044820152606401610727565b426005819055600454610c9c91611d75565b600255610cd46001600160a01b037f00000000000000000000000095b3f9797077ddca971ab8524b439553a220eb2a1633308561187f565b6040518281527fde88a922e0d3b88b24e9623efeb464919c6bf9f66857a65e2bfcf2ce87a9433d9060200160405180910390a15050565b610d13611716565b33610d1c611468565b600755610d276111a2565b6005556001600160a01b03811615610d6e57610d42816105eb565b6001600160a01b0382166000908152600e6020908152604080832093909355600754600d909152919020555b336000908152600e60205260409020548015610e1857336000908152600e6020526040812081905560068054839290610da8908490611d23565b90915550610de290506001600160a01b037f00000000000000000000000095b3f9797077ddca971ab8524b439553a220eb2a163383611817565b60405181815233907fe2403640ba68fed3a2f88b7557551d1993f84b99bb10ff833f0cf8db0c5e04869060200160405180910390a25b5050610e246001600055565b565b610e2e6118bd565b6001600160a01b038216610e735760405162461bcd60e51b815260206004820152600c60248201526b4e6f2030206164647265737360a01b6044820152606401610727565b6001600160a01b03919091166000908152601160205260409020805460ff1916911515919091179055565b610ea66118bd565b610e24600061191d565b610eb86118bd565b6202a300811115610eff5760405162461bcd60e51b8152602060048201526011602482015270496e76616c69642074696d65206c6f636b60781b6044820152606401610727565b600b81905560405181907f624a990d415409f4f6a7dd10c6bc38e894e922c55d02e0779584ab6def75103f90600090a250565b610f3a611716565b610f42611977565b33610f4b611468565b600755610f566111a2565b6005556001600160a01b03811615610f9d57610f71816105eb565b6001600160a01b0382166000908152600e6020908152604080832093909355600754600d909152919020555b60008311610fde5760405162461bcd60e51b815260206004820152600e60248201526d043616e6e6f74207374616b6520360941b6044820152606401610727565b7f000000000000000000000000afccb724e3aec1657fc9514e3e53a0e71e80622d6001600160a01b0316826001600160a01b0316148061104f57507f00000000000000000000000095b3f9797077ddca971ab8524b439553a220eb2a6001600160a01b0316826001600160a01b0316145b61108b5760405162461bcd60e51b815260206004820152600d60248201526c24b73b30b634b2103a37b5b2b760991b6044820152606401610727565b61109361176f565b33600090815260136020526040812060088054919286926110b5908490611d75565b909155505033600090815260106020526040812080548692906110d9908490611d75565b9091555050336000908152600f602090815260408083206001600160a01b038716845290915281208054869290611111908490611d75565b909155505060095433600090815260106020526040902054670de0b6b3a76400009161113c91611d3c565b6111469190611d53565b8155336000818152600c60205260409020429055611170906001600160a01b03851690308761187f565b60405184815233907f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d9060200161092c565b600060025442106111b4575060025490565b504290565b60006111c433611325565b90506000811180156111d857506000600854115b15610a8e57336000908152601360209081526040808320601090925290912054600954670de0b6b3a76400009061120f9083611d3c565b6112199190611d53565b8255600a8054849190600090611230908490611d75565b9091555061126a90506001600160a01b037f000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc8163385611817565b60405183815233907f0f7f5b155b0b0ac6890709a2c7bf1b8bb3f675fff1e7840b4dd3c9acde59048b9060200160405180910390a2505050565b60006008546000036112b857506000919050565b6001600160a01b0382166000908152600d60205260408120546112d9611468565b6112e39190611d23565b6001600160a01b038416600090815260106020526040902054909150670de0b6b3a764000090611314908390611d3c565b61131e9190611d53565b9392505050565b600060085460000361133957506000919050565b6001600160a01b03821660009081526013602090815260408083206010909252822054815460095492939192670de0b6b3a7640000906113799085611d3c565b6113839190611d53565b61067b9190611d23565b6113956118bd565b600254421161142d5760405162461bcd60e51b815260206004820152605860248201527f50726576696f7573207265776172647320706572696f64206d7573742062652060448201527f636f6d706c657465206265666f7265206368616e67696e672074686520647572606482015277185d1a5bdb88199bdc881d1a19481b995dc81c195c9a5bd960421b608482015260a401610727565b60048190556040518181527ffb46ca5a5e06d4540d6387b930a7c978bce0db5f449ec6b3f5d07c6e1d44f2d39060200160405180910390a150565b600060085460000361147b575060075490565b60006005546114886111a2565b6114929190611d23565b90506000600354826114a49190611d3c565b6114b690670de0b6b3a7640000611d3c565b90506000600854826114c89190611d53565b905060008160075461067b9190611d75565b6114e26118bd565b6001600160a01b0381166115475760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b6064820152608401610727565b610a8e8161191d565b611558611716565b33611561611468565b60075561156c6111a2565b6005556001600160a01b038116156115b357611587816105eb565b6001600160a01b0382166000908152600e6020908152604080832093909355600754600d909152919020555b6115bb61176f565b336000908152600e6020526040812080549082905560068054919283926115e3908490611d23565b9091555050336000908152601360205260408120600880549192849261160a908490611d75565b9091555050336000908152601060205260408120805484929061162e908490611d75565b9091555050336000908152600f602090815260408083207f00000000000000000000000095b3f9797077ddca971ab8524b439553a220eb2a6001600160a01b0316845290915281208054849290611686908490611d75565b909155505060095433600090815260106020526040902054670de0b6b3a7640000916116b191611d3c565b6116bb9190611d53565b8155336000818152600c602052604090819020429055517f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d906117019085815260200190565b60405180910390a2505050610e246001600055565b6002600054036117685760405162461bcd60e51b815260206004820152601f60248201527f5265656e7472616e637947756172643a207265656e7472616e742063616c6c006044820152606401610727565b6002600055565b600061177a33611325565b905060008111801561178e57506000600854115b156117df5780600a60008282546117a59190611d75565b909155506117df90506001600160a01b037f000000000000000000000000ff970a61a04b1ca14834a43f5de4533ebddb5cc8163383611817565b60405181815233907f0f7f5b155b0b0ac6890709a2c7bf1b8bb3f675fff1e7840b4dd3c9acde59048b9060200160405180910390a250565b6040516001600160a01b03831660248201526044810182905261187a90849063a9059cbb60e01b906064015b60408051601f198184030181529190526020810180516001600160e01b03166001600160e01b0319909316929092179091526119bd565b505050565b6040516001600160a01b03808516602483015283166044820152606481018290526118b79085906323b872dd60e01b90608401611843565b50505050565b6001546001600160a01b03610100909104163314610e245760405162461bcd60e51b815260206004820181905260248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726044820152606401610727565b600180546001600160a01b03838116610100818102610100600160a81b031985161790945560405193909204169182907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b60015460ff1615610e245760405162461bcd60e51b815260206004820152601060248201526f14185d5cd8589b194e881c185d5cd95960821b6044820152606401610727565b6000611a12826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b0316611a929092919063ffffffff16565b9050805160001480611a33575080806020019051810190611a339190611d88565b61187a5760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6044820152691bdd081cdd58d8d9595960b21b6064820152608401610727565b6060611aa18484600085611aa9565b949350505050565b606082471015611b0a5760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6044820152651c8818d85b1b60d21b6064820152608401610727565b600080866001600160a01b03168587604051611b269190611dc9565b60006040518083038185875af1925050503d8060008114611b63576040519150601f19603f3d011682016040523d82523d6000602084013e611b68565b606091505b5091509150611b7987838387611b84565b979650505050505050565b60608315611bf3578251600003611bec576001600160a01b0385163b611bec5760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606401610727565b5081611aa1565b611aa18383815115611c085781518083602001fd5b8060405162461bcd60e51b81526004016107279190611de5565b80356001600160a01b0381168114611c3957600080fd5b919050565b600060208284031215611c5057600080fd5b61131e82611c22565b60008060408385031215611c6c57600080fd5b82359150611c7c60208401611c22565b90509250929050565b600060208284031215611c9757600080fd5b5035919050565b8015158114610a8e57600080fd5b60008060408385031215611cbf57600080fd5b611cc883611c22565b91506020830135611cd881611c9e565b809150509250929050565b60008060408385031215611cf657600080fd5b611cff83611c22565b9150611c7c60208401611c22565b634e487b7160e01b600052601160045260246000fd5b81810381811115611d3657611d36611d0d565b92915050565b8082028115828204841417611d3657611d36611d0d565b600082611d7057634e487b7160e01b600052601260045260246000fd5b500490565b80820180821115611d3657611d36611d0d565b600060208284031215611d9a57600080fd5b815161131e81611c9e565b60005b83811015611dc0578181015183820152602001611da8565b50506000910152565b60008251611ddb818460208701611da5565b9190910192915050565b6020815260008251806020840152611e04816040850160208701611da5565b601f01601f1916919091016040019291505056fea26469706673582212200a824a61c7fee1ade4b7100557b4e27d67837a611438e647324cf5d8a042d98564736f6c63430008120033");
        // DUAL_STAKING = dual_staking(token5);
     

        USDC_WATER = usdc_water(address(new EmptyContract6()));
        vm.etch(address(USDC_WATER), hex"60806040526004361061004e5760003560e01c80633659cfe6146100655780634f1ef286146100855780635c60da1b146100985780638f283970146100c9578063f851a440146100e95761005d565b3661005d5761005b6100fe565b005b61005b6100fe565b34801561007157600080fd5b5061005b6100803660046106ed565b610118565b61005b610093366004610707565b610164565b3480156100a457600080fd5b506100ad6101da565b6040516001600160a01b03909116815260200160405180910390f35b3480156100d557600080fd5b5061005b6100e43660046106ed565b610217565b3480156100f557600080fd5b506100ad610241565b6101066102a2565b610116610111610346565b610355565b565b610120610379565b6001600160a01b0316336001600160a01b0316141561015957610154816040518060200160405280600081525060006103ac565b610161565b6101616100fe565b50565b61016c610379565b6001600160a01b0316336001600160a01b031614156101cd576101c88383838080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250600192506103ac915050565b6101d5565b6101d56100fe565b505050565b60006101e4610379565b6001600160a01b0316336001600160a01b0316141561020c57610205610346565b9050610214565b6102146100fe565b90565b61021f610379565b6001600160a01b0316336001600160a01b03161415610159576101548161040b565b600061024b610379565b6001600160a01b0316336001600160a01b0316141561020c57610205610379565b606061029183836040518060600160405280602781526020016108016027913961045f565b9392505050565b803b15155b919050565b6102aa610379565b6001600160a01b0316336001600160a01b031614156103415760405162461bcd60e51b815260206004820152604260248201527f5472616e73706172656e745570677261646561626c6550726f78793a2061646d60448201527f696e2063616e6e6f742066616c6c6261636b20746f2070726f78792074617267606482015261195d60f21b608482015260a4015b60405180910390fd5b610116565b600061035061053a565b905090565b3660008037600080366000845af43d6000803e808015610374573d6000f35b3d6000fd5b60007fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035b546001600160a01b0316905090565b6103b583610562565b6040516001600160a01b038416907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a26000825111806103f65750805b156101d557610405838361026c565b50505050565b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f610434610379565b604080516001600160a01b03928316815291841660208301520160405180910390a161016181610611565b606061046a84610298565b6104c55760405162461bcd60e51b815260206004820152602660248201527f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f6044820152651b9d1c9858dd60d21b6064820152608401610338565b600080856001600160a01b0316856040516104e09190610785565b600060405180830381855af49150503d806000811461051b576040519150601f19603f3d011682016040523d82523d6000602084013e610520565b606091505b509150915061053082828661069d565b9695505050505050565b60007f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc61039d565b61056b81610298565b6105cd5760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b6064820152608401610338565b807f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5b80546001600160a01b0319166001600160a01b039290921691909117905550565b6001600160a01b0381166106765760405162461bcd60e51b815260206004820152602660248201527f455243313936373a206e65772061646d696e20697320746865207a65726f206160448201526564647265737360d01b6064820152608401610338565b807fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61036105f0565b606083156106ac575081610291565b8251156106bc5782518084602001fd5b8160405162461bcd60e51b815260040161033891906107a1565b80356001600160a01b038116811461029d57600080fd5b6000602082840312156106fe578081fd5b610291826106d6565b60008060006040848603121561071b578182fd5b610724846106d6565b9250602084013567ffffffffffffffff80821115610740578384fd5b818601915086601f830112610753578384fd5b813581811115610761578485fd5b876020828501011115610772578485fd5b6020830194508093505050509250925092565b600082516107978184602087016107d4565b9190910192915050565b60006020825282518060208401526107c08160408501602087016107d4565b601f01601f19169190910160400192915050565b60005b838110156107ef5781810151838201526020016107d7565b83811115610405575050600091015256fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a264697066735822122093f028255035b61df476b13b9dba3c4f06f60e51b9b4caee31680b389aef327f64736f6c63430008020033");
        // USDC_WATER = usdc_water(token6);

        WETH_WATER = weth_water(address(new EmptyContract7()));
        vm.etch(address(WETH_WATER), hex"60806040523661001357610011610017565b005b6100115b61001f6101b7565b6001600160a01b0316336001600160a01b0316141561016f5760606001600160e01b031960003516631b2ce7f360e11b8114156100655761005e6101ea565b9150610167565b6001600160e01b0319811663278f794360e11b14156100865761005e610241565b6001600160e01b031981166308f2839760e41b14156100a75761005e610287565b6001600160e01b031981166303e1469160e61b14156100c85761005e6102b8565b6001600160e01b03198116635c60da1b60e01b14156100e95761005e6102f8565b60405162461bcd60e51b815260206004820152604260248201527f5472616e73706172656e745570677261646561626c6550726f78793a2061646d60448201527f696e2063616e6e6f742066616c6c6261636b20746f2070726f78792074617267606482015261195d60f21b608482015260a4015b60405180910390fd5b815160208301f35b61017761030c565b565b606061019e83836040518060600160405280602781526020016108576027913961031c565b9392505050565b90565b6001600160a01b03163b151590565b60007fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035b546001600160a01b0316919050565b60606101f4610394565b600061020336600481846106a2565b81019061021091906106e8565b905061022d8160405180602001604052806000815250600061039f565b505060408051602081019091526000815290565b606060008061025336600481846106a2565b8101906102609190610719565b915091506102708282600161039f565b604051806020016040528060008152509250505090565b6060610291610394565b60006102a036600481846106a2565b8101906102ad91906106e8565b905061022d816103cb565b60606102c2610394565b60006102cc6101b7565b604080516001600160a01b03831660208201529192500160405160208183030381529060405291505090565b6060610302610394565b60006102cc610422565b610177610317610422565b610431565b6060600080856001600160a01b0316856040516103399190610807565b600060405180830381855af49150503d8060008114610374576040519150601f19603f3d011682016040523d82523d6000602084013e610379565b606091505b509150915061038a86838387610455565b9695505050505050565b341561017757600080fd5b6103a8836104d3565b6000825111806103b55750805b156103c6576103c48383610179565b505b505050565b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f6103f46101b7565b604080516001600160a01b03928316815291841660208301520160405180910390a161041f81610513565b50565b600061042c6105bc565b905090565b3660008037600080366000845af43d6000803e808015610450573d6000f35b3d6000fd5b606083156104c15782516104ba576001600160a01b0385163b6104ba5760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000604482015260640161015e565b50816104cb565b6104cb83836105e4565b949350505050565b6104dc8161060e565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6001600160a01b0381166105785760405162461bcd60e51b815260206004820152602660248201527f455243313936373a206e65772061646d696e20697320746865207a65726f206160448201526564647265737360d01b606482015260840161015e565b807fb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d61035b80546001600160a01b0319166001600160a01b039290921691909117905550565b60007f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc6101db565b8151156105f45781518083602001fd5b8060405162461bcd60e51b815260040161015e9190610823565b6001600160a01b0381163b61067b5760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b606482015260840161015e565b807f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc61059b565b600080858511156106b257600080fd5b838611156106bf57600080fd5b5050820193919092039150565b80356001600160a01b03811681146106e357600080fd5b919050565b6000602082840312156106fa57600080fd5b61019e826106cc565b634e487b7160e01b600052604160045260246000fd5b6000806040838503121561072c57600080fd5b610735836106cc565b9150602083013567ffffffffffffffff8082111561075257600080fd5b818501915085601f83011261076657600080fd5b81358181111561077857610778610703565b604051601f8201601f19908116603f011681019083821181831017156107a0576107a0610703565b816040528281528860208487010111156107b957600080fd5b8260208601602083013760006020848301015280955050505050509250929050565b60005b838110156107f65781810151838201526020016107de565b838111156103c45750506000910152565b600082516108198184602087016107db565b9190910192915050565b60208152600082518060208401526108428160408501602087016107db565b601f01601f1916919091016040019291505056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a264697066735822122012bb4f564f73959a03513dc74fc3c6e40e8386e6f02c16b78d6db00ce0aa16af64736f6c63430008090033");
        // WETH_WATER = weth_water(token7);

        _PRINCIPAL_TOKEN_ADDRESS_USDC = principal_token_address_usdc(address(new EmptyContract8()));
        vm.etch(address(_PRINCIPAL_TOKEN_ADDRESS_USDC), hex"60806040526004361061005a5760003560e01c80635c60da1b116100435780635c60da1b146101315780638f2839701461016f578063f851a440146101af5761005a565b80633659cfe6146100645780634f1ef286146100a4575b6100626101c4565b005b34801561007057600080fd5b506100626004803603602081101561008757600080fd5b503573ffffffffffffffffffffffffffffffffffffffff166101de565b610062600480360360408110156100ba57600080fd5b73ffffffffffffffffffffffffffffffffffffffff82351691908101906040810160208201356401000000008111156100f257600080fd5b82018360208201111561010457600080fd5b8035906020019184600183028401116401000000008311171561012657600080fd5b509092509050610232565b34801561013d57600080fd5b50610146610309565b6040805173ffffffffffffffffffffffffffffffffffffffff9092168252519081900360200190f35b34801561017b57600080fd5b506100626004803603602081101561019257600080fd5b503573ffffffffffffffffffffffffffffffffffffffff16610318565b3480156101bb57600080fd5b50610146610420565b6101cc610466565b6101dc6101d76104fa565b61051f565b565b6101e6610543565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156102275761022281610568565b61022f565b61022f6101c4565b50565b61023a610543565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156102fc5761027683610568565b60003073ffffffffffffffffffffffffffffffffffffffff16348484604051808383808284376040519201945060009350909150508083038185875af1925050503d80600081146102e3576040519150601f19603f3d011682016040523d82523d6000602084013e6102e8565b606091505b50509050806102f657600080fd5b50610304565b6103046101c4565b505050565b60006103136104fa565b905090565b610320610543565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156102275773ffffffffffffffffffffffffffffffffffffffff81166103bf576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260368152602001806106966036913960400191505060405180910390fd5b7f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f6103e8610543565b6040805173ffffffffffffffffffffffffffffffffffffffff928316815291841660208301528051918290030190a1610222816105bd565b6000610313610543565b6000813f7fc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a47081811480159061045e57508115155b949350505050565b61046e610543565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156104f2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260328152602001806106646032913960400191505060405180910390fd5b6101dc6101dc565b7f7050c9e0f4ca769c69bd3a8ef740bc37934f8e2c036e5a723fd8ee048ed3f8c35490565b3660008037600080366000845af43d6000803e80801561053e573d6000f35b3d6000fd5b7f10d6a54a4754c8869d6886b5f5d7fbfa5b4522237ea5c60d11bc4e7a1ff9390b5490565b610571816105e1565b6040805173ffffffffffffffffffffffffffffffffffffffff8316815290517fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b9181900360200190a150565b7f10d6a54a4754c8869d6886b5f5d7fbfa5b4522237ea5c60d11bc4e7a1ff9390b55565b6105ea8161042a565b61063f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603b8152602001806106cc603b913960400191505060405180910390fd5b7f7050c9e0f4ca769c69bd3a8ef740bc37934f8e2c036e5a723fd8ee048ed3f8c35556fe43616e6e6f742063616c6c2066616c6c6261636b2066756e6374696f6e2066726f6d207468652070726f78792061646d696e43616e6e6f74206368616e6765207468652061646d696e206f6620612070726f787920746f20746865207a65726f206164647265737343616e6e6f742073657420612070726f787920696d706c656d656e746174696f6e20746f2061206e6f6e2d636f6e74726163742061646472657373a2646970667358221220119e941d353783c92238fbc4e38a3a0327e471d10cff47c0a5066819d4a4195664736f6c634300060c0033");
        // _PRINCIPAL_TOKEN_ADDRESS_USDC = principal_token_address_usdc(token8);
        usdc = IERC20(address(_PRINCIPAL_TOKEN_ADDRESS_USDC));

        _PRINCIPAL_TOKEN_ADDRESS_ETH = address(new EmptyContract9());
        // vm.etch(address(_PRINCIPAL_TOKEN_ADDRESS_ETH), hex"");



        // Create Virtual LP instance
        virtualLP = new VirtualLP(
            psmSender,
            _AMOUNT_TO_CONVERT,
            _FUNDING_PHASE_DURATION,
            _FUNDING_MIN_AMOUNT
        );
        address _VIRTUAL_LP = address(virtualLP);

        // Create Portal instances
        portal_USDC = new PortalV2MultiAsset(
            _VIRTUAL_LP,
            _TARGET_CONSTANT_USDC,
            address(_PRINCIPAL_TOKEN_ADDRESS_USDC),
            _DECIMALS_USDC,
            "USD Coin",
            "USDC",
            _META_DATA_URI
        );
        portal_ETH = new PortalV2MultiAsset(
            _VIRTUAL_LP,
            _TARGET_CONSTANT_WETH,
            _PRINCIPAL_TOKEN_ADDRESS_ETH,
            _DECIMALS,
            "ETHER",
            "ETH",
            _META_DATA_URI
        );

        // creation time
        timestamp = block.timestamp;
        fundingPhase = timestamp + _FUNDING_PHASE_DURATION;
        ownerExpiry = timestamp + OWNER_DURATION;
        hundredYearsLater = timestamp + 100 * SECONDS_PER_YEAR;

        // Deal tokens to addresses
        vm.deal(Alice, 1 ether);
        vm.prank(psmSender);
        psm.transfer(Alice, psmAmount);
        vm.prank(usdcSender);
        usdc.transfer(Alice, usdcAmount);

        vm.deal(Bob, 1 ether);
        vm.prank(psmSender);
        psm.transfer(Bob, psmAmount);
        vm.prank(usdcSender);
        usdc.transfer(Bob, usdcAmount);

        vm.deal(Karen, 1 ether);
        vm.prank(psmSender);
        psm.transfer(Karen, psmAmount);
        vm.prank(usdcSender);
        usdc.transfer(Karen, usdcAmount);
    }


//////////// testSuccess_buyPortalEnergy ////////////

    // function check_testSuccess_buyPortalEnergy(uint256 fuzzAmount) public { // @audit-ok => FV
    //     helper_prepareSystem();

    //     uint256 portalEnergy;
    //     (, , , , portalEnergy, , ) = portal_USDC.getUpdateAccount(
    //         Alice,
    //         0,
    //         true
    //     );
    //     uint256 minOperationalAmount = 1e4; // Ejemplo de un mÃ­nimo operativo que considera las tarifas
    //     uint256 aliceInitialUSDCBalance = usdc.balanceOf(Alice);
    //     vm.assume(fuzzAmount >= minOperationalAmount && fuzzAmount <= aliceInitialUSDCBalance);

    //     vm.startPrank(Alice);
    //     psm.approve(address(portal_USDC), 1e55);
    //     portal_USDC.buyPortalEnergy(Alice, fuzzAmount, 1, block.timestamp);
    //     vm.stopPrank();

    //     (, , , , portalEnergy, , ) = portal_USDC.getUpdateAccount(
    //         Alice,
    //         0,
    //         true
    //     );

    //     uint256 reserve1 = _TARGET_CONSTANT_USDC / _FUNDING_MIN_AMOUNT;
    //     uint256 netPSMinput = (fuzzAmount * 99) / 100;
    //     uint256 result = (netPSMinput * reserve1) /
    //         (netPSMinput + _FUNDING_MIN_AMOUNT);

    //     assert(portalEnergy == result);
    // }
    bool setUpInvoked;

    function check_testSuccess_buyPortalEnergy() public { 

        console2.log("codesize");
        helper_prepareSystem();

        // uint256 vie = svm.createUint(0,'vie');

        // setUpInvoked = true;
        // assertTrue(setUpInvoked);

        // uint256 portalEnergy;
        // (, , , , portalEnergy, , ) = portal_USDC.getUpdateAccount(
        //     address(Alice),
        //     vie,
        //     setUpInvoked
        // );

    
    }
////////////// HELPER FUNCTIONS /////////////

////////////// HELPER FUNCTIONS /////////////



    // function helper_Stake(address account, uint256 fuzzAmount) public {

    //  // STAKE //
    //     uint256 InitialUSDCBalance = usdc.balanceOf(account);

    //     // AprobaciÃ³n y Stake
    //     vm.startPrank(account);
    //     usdc.approve(address(portal_USDC), fuzzAmount);
    //     portal_USDC.stake(fuzzAmount);
    //     vm.stopPrank();

    //     uint256 FinalUSDCBalance = usdc.balanceOf(account);

    //     // Verificaciones
    //     assertEq(InitialUSDCBalance - fuzzAmount, FinalUSDCBalance, "El balance de Alice despues del stake es incorrecto.");
    //     assertEq(portal_USDC.totalPrincipalStaked(), fuzzAmount, "El total principal staked no coincide con el monto de stake.");

    // }
    // create the bToken token
    function helper_create_bToken() public {
        virtualLP.create_bToken();
    }

    // fund the Virtual LP
    function helper_fundLP() public {
        vm.startPrank(psmSender);

        psm.approve(address(virtualLP), 1e55);
        virtualLP.contributeFunding(_FUNDING_MIN_AMOUNT);

        vm.stopPrank();
    }

    // Register USDC Portal
    function helper_registerPortalUSDC() public {
        vm.prank(psmSender);
        virtualLP.registerPortal(
            address(portal_USDC),
            address(_PRINCIPAL_TOKEN_ADDRESS_USDC),
            address(USDC_WATER),
            _POOL_ID_USDC
        );
    }

    // Register ETH Portal
    function helper_registerPortalETH() public {
        vm.prank(psmSender);
        virtualLP.registerPortal(
            address(portal_ETH),
            _PRINCIPAL_TOKEN_ADDRESS_ETH,
            address(WETH_WATER),
            _POOL_ID_WETH
        );
    }

    // activate the Virtual LP
    function helper_activateLP() public {
        vm.warp(fundingPhase);
        virtualLP.activateLP();
    }

    // fund and activate the LP and register both Portals
    function helper_prepareSystem() public {
        helper_create_bToken();
        helper_fundLP();
        helper_registerPortalETH();
        helper_registerPortalUSDC();
        helper_activateLP();
    }

    // // Deploy the NFT contract
    // function helper_createNFT() public {
    //     portal_USDC.create_portalNFT();
    // }

    // // Deploy the ERC20 contract for mintable Portal Energy
    // function helper_createPortalEnergyToken() public {
    //     portal_USDC.create_portalEnergyToken();
    // }

    // // Increase allowance of tokens used by the USDC Portal
    // function helper_setApprovalsInLP_USDC() public {
    //     virtualLP.increaseAllowanceDualStaking();
    //     virtualLP.increaseAllowanceSingleStaking(address(portal_USDC));
    //     virtualLP.increaseAllowanceVault(address(portal_USDC));
    // }

    // // Increase allowance of tokens used by the ETH Portal
    // function helper_setApprovalsInLP_ETH() public {
    //     virtualLP.increaseAllowanceDualStaking();
    //     virtualLP.increaseAllowanceSingleStaking(address(portal_ETH));
    //     virtualLP.increaseAllowanceVault(address(portal_ETH));
    // }

    // // send USDC to LP when balance is required
    // function helper_sendUSDCtoLP() public {
    //     vm.prank(usdcSender);
    //     usdc.transfer(address(virtualLP), usdcSendAmount); // Send 1k USDC to LP
    // }

    // // simulate a full convert() cycle
    // function helper_executeConvert() public {
    //     helper_sendUSDCtoLP();
    //     vm.startPrank(psmSender);
    //     psm.approve(address(virtualLP), 1e55);
    //     virtualLP.convert(
    //         address(_PRINCIPAL_TOKEN_ADDRESS_USDC),
    //         msg.sender,
    //         1,
    //         block.timestamp
    //     );
    //     vm.stopPrank();
    // }
}

contract EmptyContract { }
contract EmptyContract2 { }
contract EmptyContract3 { }
contract EmptyContract4 { }
contract EmptyContract5 { }
contract EmptyContract6 { }
contract EmptyContract7 { }
contract EmptyContract8 { }
contract EmptyContract9 { }
